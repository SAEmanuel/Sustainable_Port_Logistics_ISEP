@startuml
' ==========================================================
' Sequence Diagram â€“ US2.2.2 (Register and Update Vessel Records)
' Style aligned with VesselType diagram (interfaces + mappers)
' Author: Jorge Ubaldo Rodrigues
' ==========================================================

skinparam monochrome true
skinparam shadowing false
skinparam sequenceMessageAlign center

actor "Port Authority Officer" as Officer
boundary "API Layer\n(VesselController)\n<<uses IVesselService>>" as Controller
control "Application Layer\n(VesselService)\n(implements IVesselService)" as Service
control "Mapper\n(VesselMapper)" as Mapper
control "Factory\n(VesselFactory)" as Factory
entity "Repository\n<<interface>>\n(IVesselRepository)" as IRepo
entity "Repository Impl\n(VesselRepository)" as Repo
entity "VesselTypeRepository\n<<interface>>\n(IVesselTypeRepository)" as ITypeRepo
entity "VesselTypeRepository Impl\n(VesselTypeRepository)" as TypeRepo
entity "UnitOfWork\n<<interface>>\n(IUnitOfWork)" as UoW
collections "Audit/Logs\n(ILogger / Serilog)" as Log
database "Database" as DB

' ==========================================================
' CREATE VESSEL
' ==========================================================
== Create ==
Officer -> Controller : POST /api/vessel\nBody: CreatingVesselDto
Controller -> Service : CreateAsync(dto)  <<calls IVesselService.CreateAsync>>

Service -> ITypeRepo : GetByNameAsync(dto.VesselTypeName)
ITypeRepo --> Service : VesselType / null
ITypeRepo -> TypeRepo : delegate to implementation

Service -> IRepo : GetByImoNumberAsync(dto.ImoNumber)
IRepo --> Service : null / Vessel (duplicate check)
IRepo -> Repo : delegate to implementation

Service -> Factory : CreateVessel(dto, vesselTypeId)
Factory --> Service : Vessel (entity)

Service -> IRepo : AddAsync(vessel)
IRepo -> Repo : persist vessel
Repo -> DB : INSERT Vessel
DB --> Repo : OK
Repo --> IRepo : persisted
IRepo --> Service : Entity persisted

Service -> UoW : CommitAsync()
UoW --> Service : Transaction committed

Service -> Mapper : CreateVesselDto(vessel)
Mapper --> Service : VesselDto

Service -> Log : Log(CREATE, officerId, vessel.ImoNumber, SUCCESS)
Service --> Controller : VesselDto
Controller --> Officer : 201 Created (VesselDto)

' ==========================================================
' PATCH BY IMO (UPDATE)
' ==========================================================
== Patch by IMO ==
Officer -> Controller : PATCH /api/vessel/imo/{imo}\nBody: UpdatingVesselDto
Controller -> Service : PatchByImoAsync(imo, dto)  <<calls IVesselService.PatchByImoAsync>>

Service -> IRepo : GetByImoNumberAsync(imo)
IRepo --> Service : Vessel / null
IRepo -> Repo : SELECT ...

Service -> Service : ApplyUpdates(name?, owner?)
Service -> UoW : CommitAsync()  'persist changes via UoW
UoW --> Service : Transaction committed

Service -> Mapper : CreateVesselDto(vessel)
Mapper --> Service : VesselDto

Service -> Log : Log(UPDATE, officerId, imo, SUCCESS)
Service --> Controller : VesselDto
Controller --> Officer : 200 OK (VesselDto)

' ==========================================================
' GET ALL
' ==========================================================
== Get All ==
Officer -> Controller : GET /api/vessel
Controller -> Service : GetAllAsync()

Service -> IRepo : GetAllAsync()
IRepo --> Service : List<Vessel>
IRepo -> Repo : SELECT ...

Service -> Mapper : CreateVesselDto(vessel*)  'maps each entity
Mapper --> Service : List<VesselDto>

Service --> Controller : List<VesselDto>
Controller --> Officer : 200 OK (List<VesselDto>)

' ==========================================================
' GET BY ID
' ==========================================================
== Get by Id ==
Officer -> Controller : GET /api/vessel/id/{id}
Controller -> Service : GetByIdAsync(id)

Service -> IRepo : GetByIdAsync(id)
IRepo --> Service : Vessel / null

Service -> Mapper : CreateVesselDto(vessel)
Mapper --> Service : VesselDto

Service --> Controller : VesselDto
Controller --> Officer : 200 OK (VesselDto)

' ==========================================================
' GET BY IMO
' ==========================================================
== Get by IMO ==
Officer -> Controller : GET /api/vessel/imo/{imo}
Controller -> Service : GetByImoNumberAsync(imo)

Service -> IRepo : GetByImoNumberAsync(imo)
IRepo --> Service : Vessel / null

Service -> Mapper : CreateVesselDto(vessel)
Mapper --> Service : VesselDto

Service --> Controller : VesselDto
Controller --> Officer : 200 OK (VesselDto)

' ==========================================================
' GET BY NAME
' ==========================================================
== Get by Name ==
Officer -> Controller : GET /api/vessel/name/{name}
Controller -> Service : GetByNameAsync(name)

Service -> IRepo : GetByNameAsync(name)
IRepo --> Service : List<Vessel>

Service -> Mapper : CreateVesselDto(vessel*)
Mapper --> Service : List<VesselDto>

Service --> Controller : List<VesselDto>
Controller --> Officer : 200 OK (List<VesselDto))

' ==========================================================
' GET BY OWNER
' ==========================================================
== Get by Owner ==
Officer -> Controller : GET /api/vessel/owner/{owner}
Controller -> Service : GetByOwnerAsync(owner)

Service -> IRepo : GetByOwnerAsync(owner)
IRepo --> Service : List<Vessel>

Service -> Mapper : CreateVesselDto(vessel*)
Mapper --> Service : List<VesselDto>

Service --> Controller : List<VesselDto>
Controller --> Officer : 200 OK (List<VesselDto))

' ==========================================================
' FILTER
' ==========================================================
== Filter ==
Officer -> Controller : GET /api/vessel/filter?name=x&imo=y&owner=z&query=q
Controller -> Service : GetFilterAsync(name, imo, owner, query)

Service -> IRepo : GetFilterAsync(name, imoNumber?, owner, query)
IRepo --> Service : List<Vessel>

Service -> Mapper : CreateVesselDto(vessel*)
Mapper --> Service : List<VesselDto>

Service --> Controller : List<VesselDto>
Controller --> Officer : 200 OK (List<VesselDto))

@enduml

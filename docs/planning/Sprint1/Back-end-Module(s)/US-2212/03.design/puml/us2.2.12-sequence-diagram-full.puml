@startuml
skinparam monochrome true
skinparam shadowing false
skinparam sequenceMessageAlign center
skinparam ParticipantPadding 25
skinparam responseMessageBelowArrow true

title US2.2.12 â€“ Full Sequence Diagram (Physical Resource Management)

actor "Logistics Operator" as Operator
boundary "PhysicalResourceController" as Controller
control "PhysicalResourceService" as Service
entity "PhysicalResourceRepository" as Repo
entity "QualificationRepository" as QualRepo
control "ILogger / AuditService" as Audit
entity "UnitOfWork" as UoW
database "PhysicalResources Database" as DB

' ==========================================================
== Create Physical Resource ==
' ==========================================================
Operator -> Controller : POST /api/PhysicalResource {CreatingPhysicalResourceDto}
Controller -> Audit : log(REQUEST, "POST /PhysicalResource", dto)
Controller -> Service : AddAsync(dto)

Service -> Audit : log(INFO, "Start AddAsync(dto)")
Service -> QualRepo : GetQualificationByCodeAsync(dto.QualificationCode)
QualRepo --> Service : Qualification or null

Service -> Repo : CountByTypeAsync(dto.PhysicalResourceType)
Repo --> DB : COUNT resources by type
DB --> Repo : count
Repo --> Service : count

Service -> Repo : AddAsync(EntityPhysicalResource)
Repo --> DB : INSERT EntityPhysicalResource
DB --> Repo : OK

Service -> UoW : CommitAsync()
UoW --> Service : Success

Service -> Audit : log(SUCCESS, "Created Resource", code)
Service --> Controller : PhysicalResourceDTO
Controller -> Audit : log(RESPONSE, 201, "Created Resource")
Controller --> Operator : 201 Created (PhysicalResourceDTO)

' ==========================================================
== Get Physical Resource By ID ==
' ==========================================================
Operator -> Controller : GET /api/PhysicalResource/get/{id}
Controller -> Audit : log(REQUEST, "GET /PhysicalResource/{id}")
Controller -> Service : GetByIdAsync(PhysicalResourceId)

Service -> Audit : log(INFO, "Fetch Resource by ID")
Service -> Repo : GetByIdAsync(id)
Repo --> DB : SELECT * FROM PhysicalResources WHERE Id = {id}
DB --> Repo : EntityPhysicalResource or null
Repo --> Service : EntityPhysicalResource or null

Service -> Audit : log(SUCCESS, "Fetched Resource {id}")
Service --> Controller : PhysicalResourceDTO or 404
Controller -> Audit : log(RESPONSE, 200/404)
Controller --> Operator : 200 OK or 404 Not Found

' ==========================================================
== Update Physical Resource ==
' ==========================================================
Operator -> Controller : PATCH /api/PhysicalResource/update/{id} {UpdatingPhysicalResource}
Controller -> Audit : log(REQUEST, "PATCH /PhysicalResource/update/{id}", dto)
Controller -> Service : UpdateAsync(PhysicalResourceId, dto)

Service -> Repo : GetByIdAsync(id)
Repo --> DB : SELECT * FROM PhysicalResources WHERE Id = {id}
DB --> Repo : EntityPhysicalResource or null
Repo --> Service : EntityPhysicalResource or null

Service -> QualRepo : ExistQualificationID(dto.QualificationId?)
QualRepo --> DB : Check qualification
DB --> QualRepo : true or false
QualRepo --> Service : true or false

Service -> UoW : CommitAsync()
UoW --> Service : Success
Service -> Audit : log(SUCCESS, "Resource Updated", id)
Service --> Controller : PhysicalResourceDTO
Controller -> Audit : log(RESPONSE, 200, "Update successful")
Controller --> Operator : 200 OK (PhysicalResourceDTO)

' ==========================================================
== Deactivate Physical Resource ==
' ==========================================================
Operator -> Controller : PATCH /api/PhysicalResource/deactivate/{id}
Controller -> Audit : log(REQUEST, "PATCH /deactivate/{id}")
Controller -> Service : DeactivationAsync(PhysicalResourceId)

Service -> Repo : GetByIdAsync(id)
Repo --> DB : SELECT * FROM PhysicalResources WHERE Id = {id}
DB --> Repo : EntityPhysicalResource or null
Repo --> Service : EntityPhysicalResource or null

Service -> UoW : CommitAsync()
UoW --> Service : Success
Service -> Audit : log(SUCCESS, "Deactivated Resource", id)
Service --> Controller : PhysicalResourceDTO
Controller -> Audit : log(RESPONSE, 200, "Deactivation successful")
Controller --> Operator : 200 OK (PhysicalResourceDTO)

' ==========================================================
== Reactivate Physical Resource ==
' ==========================================================
Operator -> Controller : PATCH /api/PhysicalResource/reactivate/{id}
Controller -> Audit : log(REQUEST, "PATCH /reactivate/{id}")
Controller -> Service : ReactivationAsync(PhysicalResourceId)

Service -> Repo : GetByIdAsync(id)
Repo --> DB : SELECT * FROM PhysicalResources WHERE Id = {id}
DB --> Repo : EntityPhysicalResource or null
Repo --> Service : EntityPhysicalResource or null

Service -> UoW : CommitAsync()
UoW --> Service : Success
Service -> Audit : log(SUCCESS, "Reactivated Resource", id)
Service --> Controller : PhysicalResourceDTO
Controller -> Audit : log(RESPONSE, 200, "Reactivation successful")
Controller --> Operator : 200 OK (PhysicalResourceDTO)

@enduml
